# Nom "hum√†" del workflow. Aix√≠ √©s com el veurem a la pestanya Actions.
name: CI (Laravel)

# Bloc que defineix QUAN s‚Äôexecuta el workflow.
on: 

  # 1) Es dispara en fer push...
  push:
    # ...per√≤ nom√©s si el push va a la branca 'main'.
    # YAML permet arrays en una sola l√≠nia: [ main ] √©s equivalent a una llista amb un element.
    branches: [ main ]
  # 2) Tamb√© es dispara quan s‚Äôobre/actualitza un pull request.
  # No especifiquem branques aqu√≠, per tant s‚Äôaplica a PRs entre qualsevol branca.
  pull_request:

# Bloc de feines (jobs) que s‚Äôexecutaran.
jobs:
  # Definim un job anomenat 'tests' (el nom √©s lliure; aqu√≠ indica que far√† proves).
  tests:
    # Indiquem a GitHub quin tipus de m√†quina virtual ha d‚Äôusar.
    # 'ubuntu-latest' √©s l‚Äô√∫ltim Ubuntu que ofereix GitHub (normalment la millor opci√≥ per PHP).
    runs-on: ubuntu-latest

    # Llista ordenada de passos dins del job 'tests'.
    steps:
      # Pas 1: descarregar el codi del repositori al runner.
      - name: Checkout
        # 'uses' vol dir que fem servir una "action" p√∫blica del Marketplace.
        # actions/checkout@v4 clona el repo a la m√†quina del job.
        uses: actions/checkout@v4

      # Pas 2: instal¬∑lar PHP i extensions necess√†ries per a Laravel.
      - name: Set up PHP
        # Action espec√≠fica per gestionar versions/ext dels PHP Runtimes.
        uses: shivammathur/setup-php@v2
        # 'with' passa par√†metres a l'action.
        with:
          # Versi√≥ de PHP que volem al runner.
          php-version: '8.2'
          # Llista d‚Äôextensions que necessitem al projecte.
          # mbstring i bcmath s√≥n habituals a Laravel; pdo_sqlite per fer tests amb SQLite.
          extensions: mbstring, bcmath, pdo_sqlite
          # Desactivem la cobertura (xdebug) per fer el job m√©s r√†pid.
          coverage: none

      # Pas 3: cachejar el directori 'vendor' perqu√® els 'composer install' siguin molt m√©s r√†pids
      # a execucions futures si no canvia el lockfile.
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          # 'path' indica qu√® volem cachejar: el directori de depend√®ncies PHP.
          path: vendor
          # 'key' identifica la "clau" del cache. Si canvia, es crea un cache nou.
          # Fem servir una expressi√≥ de GitHub ${{ ... }} per construir la clau.
          # Afegim el sistema operatiu i el hash del composer.lock (si canvia, el cache deixa de servir).
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      # Pas 4: instal¬∑lar les depend√®ncies de Composer del projecte.
      - name: Install Composer dependencies
        # 'run' executa una comanda de shell a la m√†quina del job.
        # --no-progress: menys soroll als logs
        # --prefer-dist: baixa paquets ja empaquetats (m√©s r√†pid)
        # --optimize-autoloader: millora el temps de c√†rrega en producci√≥/CI
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      # Pas 5: preparar l‚Äôentorn de proves.
      - name: Prepare environment
        # El tub '|' indica "multil√≠nia": executarem aquestes comandes, una rere l‚Äôaltra, al mateix pas.
        run: |
          # 5.1 Copiem l'exemple d'entorn a .env (a CI no exposem secrets; usem defaults).
          cp .env.example .env
          # 5.2 Generem l‚ÄôAPP_KEY necess√†ria per a Laravel (encriptaci√≥, sessions, etc.).
          php artisan key:generate
          # 5.3 Creem la base de dades SQLite (fitxer buit). Ideal per a tests en CI.
          touch database/database.sqlite
          # 5.4 Apliquem migracions perqu√® les taules existeixin abans de provar.
          # --force evita que Artisan demani confirmaci√≥ en entorns no interactius.
          php artisan migrate --force

      # Pas 6: executar els tests de Laravel.
      - name: Run tests
        # --no-coverage: no calculem cobertura (m√©s r√†pid per a una demo b√†sica).
        # (Laravel invoca PHPUnit o Pest segons la config del projecte.)
        run: php artisan test --no-coverage

  # Job de desplegament a Laravel Cloud.
  # Aquest job nom√©s s'executar√† si:
  # 1. El job 'tests' ha passat exitosament (needs: tests)
  # 2. √âs un push (no un pull request)
  # 3. √âs a la branca main
  deploy:
    # El nom que veurem a la pestanya Actions.
    name: Deploy a Laravel Cloud
    # Utilitzem la mateixa m√†quina virtual.
    runs-on: ubuntu-latest
    # Aquest job DEP√àN del job 'tests'. No s'executar√† fins que 'tests' acabi.
    needs: tests
    # Condici√≥: nom√©s s'executa si:
    # - √âs un push (no un PR)
    # - √âs a la branca main
    # - Els tests han passat (needs.tests.result == 'success')
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.tests.result == 'success'
    # Assegurar que si el job anterior falla, aquest no s'executa
    continue-on-error: false
    
    # Passos del job de deploy.
    steps:
      # Pas 1: confirmar que els tests han passat.
      - name: Verificar que els tests han passat
        run: |
          if [ "${{ needs.tests.result }}" != "success" ]; then
            echo "Error: Els tests no han passat. El resultat √©s: ${{ needs.tests.result }}"
            exit 1
          fi
          echo "‚úÖ Tots els tests han passat correctament"
          echo "üöÄ Iniciant desplegament a producci√≥..."
      
      # Pas 2: cridar al Deploy Hook de Laravel Cloud.
      # Aix√≤ desencadenar√† el desplegament autom√†tic a Laravel Cloud.
      - name: Cridar a Laravel Cloud Deploy Hook
        run: |
          # Eliminem espais en blanc al principi i final de la URL
          HOOK_URL=$(echo "${{ secrets.LARAVEL_CLOUD_DEPLOY_HOOK }}" | xargs)
          # Verifiquem que la URL no estigui buida
          if [ -z "$HOOK_URL" ]; then
            echo "Error: LARAVEL_CLOUD_DEPLOY_HOOK est√† buit o no est√† configurat"
            exit 1
          fi
          # Cridem al Deploy Hook
          curl -X POST "$HOOK_URL"
